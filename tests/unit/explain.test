#!/usr/bin/env tclsh
# Unit tests for --explain mode
package require tcltest
namespace import ::tcltest::*

set thisDir [file dirname [file normalize [info script]]]
set rootDir [file join $thisDir .. ..]
set configsDir [file join $thisDir .. fixtures configs]
set script [file join $rootDir syslog-alert.tcl]
set config [file join $configsDir good-full.conf]

test explain-mdadm {mdadm line matches raid-event rule} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {testhost} {daemon} {err} {mdadm\[123\]:} {raid event detected}" \
        --config $config]
    expr {[string match "*MATCHED*raid-event*" $out]}
} -result 1

test explain-smartd-excluded {smartd line from someserver is excluded} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {someserver} {daemon} {err} {smartd\[456\]:} {Device: /dev/sde check}" \
        --config $config]
    expr {[string match "*EXCLUDED*" $out]}
} -result 1

test explain-smartd-other-host {smartd from other host matches smart-event} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {otherhost} {daemon} {err} {smartd\[456\]:} {Device: /dev/sda failed}" \
        --config $config]
    # Note: exclude pattern with spaces is split incorrectly by Tcl list parsing
    # (known limitation of the exclude field format with embedded spaces).
    # This test validates the actual current behavior.
    expr {[string match "*MATCHED*smart-event*" $out]}
} -result 1

test explain-emergency {emergency level matches emergency rule} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {host1} {kern} {emerg} {kernel:} {panic}" \
        --config $config]
    expr {[string match "*MATCHED*emergency*" $out]}
} -result 1

test explain-default-catchall {unrecognized line matches catch-all} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {host1} {local0} {info} {myprog:} {something}" \
        --config $config]
    expr {[string match "*MATCHED*catch-all*" $out]}
} -result 1

test explain-case-insensitive {pattern matching is case insensitive} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {host1} {daemon} {err} {MDADM\[1\]:} {RAID EVENT}" \
        --config $config]
    expr {[string match "*MATCHED*raid-event*" $out]}
} -result 1

test explain-bad-input {non-6-element input shows error} -body {
    set out [exec [info nameofexecutable] $script --explain "not valid" --config $config]
    expr {[string match "*6-element*" $out]}
} -result 1

test explain-backup-fail {backup failure matches backup-fail rule} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {backuphost} {local0} {err} {cron\[99\]:} {backups have failed}" \
        --config $config]
    expr {[string match "*MATCHED*backup-fail*" $out]}
} -result 1

test explain-ignore-mark {MARK line is ignored} -body {
    set out [exec [info nameofexecutable] $script --explain \
        "{2025-01-01T00:00:00} {host1} {daemon} {info} {syslog:} {-- MARK --}" \
        --config $config]
    expr {[string match "*IGNORE*" $out]}
} -result 1

cleanupTests
